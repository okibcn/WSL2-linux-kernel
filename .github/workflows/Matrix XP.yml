name: WF test

on:
  workflow_dispatch:

jobs:
  job-config:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      configs: ${{ steps.set-matrix.outputs.configs }}
      cancel: ${{ steps.prebuild-checks.outputs.cancel }}
    defaults:
      run:
        shell: bash
    steps:
    - name: "PRE-BUILD CHECKS" 
      id: prebuild-checks
      run: |
        echo "cancel=false" >>  $GITHUB_OUTPUT


    - name: "‚è¨ Checkout repository"
      uses: actions/checkout@v3


    # - name: "üîß Prepare debug session"
    #   run: |
    #     ## install zsh
    #     sudo apt install zsh zsh-syntax-highlighting

    #     ## oh-my-posh
    #     sudo wget https://github.com/JanDeDobbeleer/oh-my-posh/releases/latest/download/posh-linux-amd64 -O /usr/local/bin/oh-my-posh
    #     sudo chmod +x /usr/local/bin/oh-my-posh

    #     ## setting rc files
    #     echo "eval \"\$(oh-my-posh init \$(oh-my-posh get shell))\"" >> ~/.bashrc
    #     echo "eval \"\$(oh-my-posh init \$(oh-my-posh get shell))\"" >> ~/.zshrc

    #     ## Default profiles
    #     wget -q https://github.com/okibcn/miniU/raw/main/Github_Linux/.nanorc -O  ~/.nanorc
    #     wget -q https://github.com/okibcn/miniU/raw/main/Github_Linux/profile.sh -O  ~/profile.sh
    #     cp /etc/bash.bashrc ~
    #     cat ~/profile.sh >> ~/bash.bashrc
    #     sudo cp ~/bash.bashrc /etc/bash.bashrc -f
    #     cp ~/profile.sh ~/.zshrc


    # - name: "üêû Debug session"
    #   uses: mxschmitt/action-tmate@v3
    #   env:
    #     GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    #     ## More info at https://til.simonwillison.net/github-actions/debug-tmate
    #     ##           or https://github.com/mxschmitt/action-tmate


    - name: "DETECT CONFIGS"
      id: set-matrix
      shell: pwsh
      run: |
        $configs=(gci *.dif).baseName
        "CONFIGS:"
        $configs

        $m=@{include = @()}
        $configs | % { $m.include+=@{config = $_} } 
        "MATRIX:"
        $m | ConvertTo-Json

        "matrix=$(($m | ConvertTo-Json -compress) -replace '"','\"')"  >> $env:GITHUB_OUTPUT
        "MATRIX STRING:"
        $setstring

        $setstring="configs=$(($m.include.config | ConvertTo-Json -compress) -replace '"','\"')"
        $setstring >> $env:GITHUB_OUTPUT
        "CONFIGS STRING:"
        $setstring


    # - name: "DETECT CONFIGS"
    #   id: set-matrix
    #   run: |
    #     # configs=$(ls *.dif | grep -Po '^[^\.]+')
    #     # echo "CONFIGS:"
    #     # echo $configs

    #     # JSON="["
    #     # ls *.dif | grep -Po '^[^\.]+' | while read config; do
    #     #   JSON="${JSON}\"${config}\","
    #     # done

    #     setstring="matrix={\"include\":[{\"config\":\"nbd\"},{\"config\":\"std\"}]}"
    #     echo $setstring >> $GITHUB_OUTPUT
    #     echo "MATRIX STRING:"
    #     echo $setstring

    #     setstring="configs=[\"nbd\",\"std\"]"
    #     echo $setstring >> $GITHUB_OUTPUT
    #     echo "CONFIGS STRING:"
    #     echo $setstring



    - name: "‚úîÔ∏è TEST matrix"
      run: |
        echo "MATRIX:"
        echo ${{ steps.set-matrix.outputs.matrix }}
        echo "CANCEL:"
        echo ${{ steps.prebuild-checks.outputs.cancel }}


  job-build:
    needs: [ job-config ]
    name: "Build configuration ${{ matrix.config }}"
    runs-on: ubuntu-latest
    strategy:
      matrix: ${{ FromJson(needs.job-config.outputs.matrix) }}
        # config: ${{ FromJson(needs.job-config.outputs.configs) }}
      fail-fast: false
    defaults:
      run:
        shell: bash
    steps:
    - name: "‚úîÔ∏è TEST matrix"
      run: |
        echo "MATRIX:"
        echo ${{ needs.job-config.outputs.matrix }}
        echo "MATRIX:"
        echo ${{ needs.job-config.outputs.configs }}
        echo "CONFIG:"
        echo ${{ matrix.config }}
        echo "CANCEL:"
        echo ${{ needs.job-config.outputs.cancel }}

